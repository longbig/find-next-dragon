# 业务场景设计题

## 1.如何避免重复发放优惠券？

#### **幂等性实现方案**

| **场景**         | **实现方式**             | **示例**                                                     |
| :--------------- | :----------------------- | :----------------------------------------------------------- |
| HTTP接口重复调用 | 唯一请求ID + Redis SETNX | 用户ID+券ID+当日日期作为Key，SETNX成功才执行业务             |
| MQ消息重复消费   | 数据库唯一索引           | 消息表增加msg_id唯一索引，重复插入直接忽略                   |
| 定时任务补偿发放 | 状态机 + 乐观锁          | 仅处理状态为"未发放"的券，SQL：UPDATE coupon SET status=1 WHERE status=0 |

## 2. 如何统计接口每分钟的调用次数？

**需求分析**

根据具体业务场景选择不同的设计方案，比如单机系统，设计一个AOP切面编程就行；分布式系统中，考虑使用Redis进行统计操作，并定时刷新Redis数据到数据库中等等

**方案汇总**

* **AOP方案**：当前系统只有一台机器，通过AOP做核心接口的切面拦截就可以实现，用ConcurrentHashMap计数，并利用定时任务每隔60s统计一次所有方法的调用次数，再清空ConcurrentHashMap
* **MQ方案**：每次调用时将接口名、分钟时间戳封装发送消息，消费端将信息处理存储到Redis中，然后进行统计
* **Redis方案**：分布式系统下，利用Redis的自增进行统计，使用接口名称+当前分钟时间戳作为key，有调用时，对应key进行原子性计数增加操作
* **Redis集群模式方案**：访问量较大时，如1W QPS，这时Redis负担会变大，且每次请求都调用Redis，也会带来性能开销。考虑使用Redis集群模式，且通过异步线程池统计调用次数，统计数据间隔2s、5s进行异步上报，但是这样会带来新的问题：**当前统计值并不是这一秒的真正访问量**
* **Nginx方案**：正常网站请求都通过Nginx作为流量入口，Nginx会记录每次访问日志，可监控nginx日志文件进行统计
* **运维方案**：引入Prometheus部署运维，天然支持counter计数器类型，通过promQL聚合分钟统计
