# 业务场景设计题

## 1.如何避免重复发放优惠券？

#### **幂等性实现方案**

| **场景**         | **实现方式**             | **示例**                                                     |
| :--------------- | :----------------------- | :----------------------------------------------------------- |
| HTTP接口重复调用 | 唯一请求ID + Redis SETNX | 用户ID+券ID+当日日期作为Key，SETNX成功才执行业务             |
| MQ消息重复消费   | 数据库唯一索引           | 消息表增加msg_id唯一索引，重复插入直接忽略                   |
| 定时任务补偿发放 | 状态机 + 乐观锁          | 仅处理状态为"未发放"的券，SQL：UPDATE coupon SET status=1 WHERE status=0 |

