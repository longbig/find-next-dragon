# 场景题：10亿QQ用户，如何统计在线人数？

现在卷的环境下，面试除了八股文+算法+项目外，场景题也是问的越来越多了。一方面是就业市场竞争者较多所带来的必然结果；另一方面是公司对于应聘者的技术要求也越来越高了。

今天继续介绍Java面试常见的场景题：**在线人数统计**

> 现在用户数量是亿级，如何统计在线人数有多少？

### 场景分析

QQ用户就是亿级的场景，我们如果使用常规的数据库解决方案是不能满足要求的。例如：在数据库中给每个QQ用户添加一个状态，上线为1，下线为0，然后统计状态为1的数据总量，就能获取在线人数了。

但是，大规模用户频繁上、下线操作，频繁读写数据库，带来巨大 IO 压力，数据库并不能满足性能要求。

### 解决方案

使用Bitmap（位数组）来存储QQ用户的在线状态，这里还是简单介绍下Bitmap的数据结构

![](D:\IdeaProjects\find-next-dragon\bagu\场景题\图片\人数统计1.png)

* 维护一个位数组，每一位只能是1或0
* 每个下标表示具体的数字，该下标位置的数字为1时，表示用户在线。如数组索引下标2333的值为1，表示QQ号2333的用户在线。反之，值为0表示下线
* 统计在线人数，只需要统计1的个数即可

### 内存占用分析

10亿QQ号，位数组的空间位是10亿，占用内存大小为：10亿 * 1bit / 8 / 1024 / 1024 = **119.2MB**，分析得出占用的内存非常小

### 具体实现

上一篇写了java的BitMap结构，这一篇换换口味，我们用Redis提供的Bitmap命令来实现

| 命令                | 功能                      | 示例                                   |
| :------------------ | :------------------------ | :------------------------------------- |
| SETBIT key offset 1 | 用户上线（设置对应位为1） | SETBIT online_users 10086 1            |
| GETBIT key offset   | 判断用户是否在线          | GETBIT online_users 10086 → 返回1      |
| BITCOUNT key        | 统计在线总人数            | BITCOUNT online_users → 返回当前在线数 |

### 小结

类似的面试场景题还有很多，最近准备收集一波做成专栏，敬请期待吧~