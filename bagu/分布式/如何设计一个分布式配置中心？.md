# 如何设计一个分布式配置中心？

> 这是小卷对分布式系统架构学习的第7篇文章，前面已经讲了很多理论知识，今天结合具体的中间件来讲分布式配置中心

## 1.面试官提问

> 面试官：假设你是公司的基础架构部门，现在需要设计内部的配置中心中间件，你要怎么设计？
>
> 我：设计客户端和服务端，客户端集成到业务项目中，项目启动时从服务端pull配置加载到本地，并且定时check服务端和本地配置是否一致，服务端如有更新，再pull到本地
>
> 面试官：那如果有几万台服务器，都是这样定时去check，服务端压力岂不是很大，要怎么解决呢？
>
> 我：那改成用服务端push的方式？？？
>
> 面试官：......
>
> 面试官：那今天就到这里吧，你回去等通知吧......

## 2.为什么需要分布式配置中心

不了解底层原理的小卷只好回家后苦心专研分布式配置中心的原理，一定要弄清楚底层逻辑，下次要吊打面试官。

**先来简单理解为什么需要配置中心？**

我们开发的服务都是单体架构时，配置文件就和代码放在一起，如springboot的application.yml文件，对配置的修改只需要修改这一个文件就行。到分布式服务中，一个服务会有多台机器，不可能每个机器都单独修改配置文件，然后重新部署的。

这就要用到配置中心了，以nacos为例，下图是配置修改时和服务器间的操作：

![](D:\IdeaProjects\find-next-dragon\bagu\img\配置中心1.png)

## 3.开源框架

这里列举4种分布式配置中心的中间件，我们直接从一个中间件的原理来学习配置中心。

工作这么多年，应该得了解一些开源组件，大大小小的都行：

1、Apollo

> 2016年5月，携程开源的配置管理中心，具备规范的权限、流程治理等特性。
>
> GitHub地址：https://github.com/apolloconfig/apollo

2、spring cloud config

> 2014年9月开源，Spring Cloud 生态组件，可以和Spring Cloud体系无缝整合。

3、Nacos

> 2018年6月，阿里开源的配置中心，也可以做DNS和RPC的服务发现。

4、Diamond

> Diamond 出自淘宝，开源地址 【https://github.com/takeseem/diamond】 ，阿里集团内部的配置中心仍然用的diamond，只是开源版本不再维护

**面试时可能会问到为什么选择Apollo作为配置中心？不用其他的配置中心呢？**

很多人用的时候就是看别人也这么用，或者大家都这么用，就选择了这个中间件。这里如果遇到了的话，就可以提到开源社区的活跃性，因为Apollo 的社区生态活跃，且使用的公司特别多，常见的坑基本都被踩完了，所以选用Apollo。

## 4. Apollo工作原理

### 4.1基础模型

Apollo文档：[Apollo配置中心设计](https://www.apolloconfig.com/#/zh/design/apollo-design)，工作原理比较简单：

1. 用户在配置中心对配置进行修改并发布
2. 配置中心通知Apollo客户端有配置更新
3. Apollo客户端从配置中心拉取最新配置，更新本地配置并通知到应用

![](D:\IdeaProjects\find-next-dragon\bagu\img\配置中心2.png)