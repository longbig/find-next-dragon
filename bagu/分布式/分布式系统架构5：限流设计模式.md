# 分布式系统架构5：限流设计模式

> 这是小卷对分布式系统架构学习的第5篇文章，今天来学习限流器和限流设计模式

## 1.为什么要限流？

任何一个系统的运算、存储、网络资源都不是无限的，当系统资源不足以支撑外部超过预期的突发流量时，就应该要有取舍，建立面对超额流量自我保护的机制，而这个机制就是微服务中常说的“限流”

## 2.四种限流设计模式

说到限流，大家直接的想法就是Sentinel，但是Sentinel限流的原理可能很多人没去深入理解，或者限流到底是怎么做的？具体如何进行限流，业界内也有一些常见设计模式。

### 2.1流量计数器模式

流量计数器是一种最简单的限流方式，通过记录固定时间窗口内的请求次数来判断是否达到限流阈值。如果请求次数超过限制值，则拒绝后续请求。

**实现方式：**

* 将时间划分为固定的时间窗口（如 1 秒、1 分钟）。

* 每个窗口维护一个计数器，记录当前时间窗口内的请求次数。

* 如果计数器值超过限流阈值，直接拒绝请求；否则增加计数器。

**固定窗口边界问题：**

* 在窗口边界的两端，可能存在短时间内超量请求的“**临界问题**”

比如场景设定：一秒内的TPS大于80时，就限流。

存在问题：即使每一秒的统计流量都没有超过 80 TPS，也不能说明系统没有遇到过大于 80 TPS 的流量压力。比如说系统在连续2秒内都收到60TPS的请求，但是请求发生的时间分别在第1秒的后0.5秒，以及第2秒的前0.5秒。这样系统实际曾在1秒内发生超过80 TPS的请求。

* 即使连续若干秒统计流量超过阈值，也不能说明流量压力一定超过系统承受能力

假设 10 秒的时间片段中，前 3 秒的 TPS 平均值到了 100，而后 7 秒的平均值是 30 左右，此时系统是否能够处理完这些请求而不产生超时失败？答案是可以的

**存在缺陷**：造成上面2个问题得原因是流量计数器模式是对时间点进行离散的统计

## 2.2滑动窗口模式

