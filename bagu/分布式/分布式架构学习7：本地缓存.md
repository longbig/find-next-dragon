# 分布式架构学习7：本地缓存

> 这是小卷对分布式系统架构学习的第10篇文章，在开始学习分布式缓存之前，先来学习本地缓存的理论基础，了解为什么需要用缓存

## 1.引入缓存的影响

我们在开发时，用到缓存的情况，无非就是为了减少客户端对相同资源的重复请求，降低服务器的负载压力。引入缓存后，既有好处也有坏处

**引入缓存负面影响：**

* 开发角度，增加了系统复杂度，需考虑缓存失效、更新、一致性问题
* 运维角度，缓存会掩盖一些缺陷问题
* 安全角度，缓存可能泄密某些保密数据

**引入缓存的理由：**

* **为了缓解CPU压力**，将实时计算运行结果存储起来，节省CPU压力
* **为了缓解I/O压力**，将原本对网络、磁盘的访问改为对内存的访问

## 2.缓存的属性

选择缓存时，主要考虑吞吐量、命中率、扩展功能、分布式支持。 前3个这篇文章会讲，下一篇再讲分布式缓存

### 2.1吞吐量

并发场景下，每秒操作数OPS，反映了缓存的工作效率

如Java8并发包的ConcurrentHashMap，线程安全实现原理是CAS+synchronized锁单个元素。但是该类仅有缓存功能，没有命中率、淘汰策略、缓存统计等功能

并发场景下，不可避免的会有读写数据带来的状态竞争问题，当前有2种处理套路：

* **以Guava Cache为代表的同步处理机制**：在访问缓存数据时，一并完成缓存淘汰、统计、失效等状态变更操作，通过分段加锁等优化手段来尽量减少数据竞争。
* **以Caffeine为代表的异步日志提交机制**：参考经典的数据库设计理论，把对数据的读、写过程看作是日志（即对数据的操作指令）的提交过程。

Caffeine使用了环形缓冲区来记录状态变动日志，为进一步减少数据竞争，Caffeine给每个线程都设置了专用的环形缓冲区，如下是Wikipedia上的环形缓冲示意：

![](/Users/yuyunlong/IdeaProjects/find-next-dragon/bagu/img/本地缓存1.gif)

> 环形缓冲区结构中，读取和写入是一起进行的，只要读取指针不落后于写指针一圈，这个操作可以永久进行下去，容纳无限多的新字符。
>
> 如果不满足，则必须阻塞写指针，等待读取清空缓冲区

