# 注册中心如何选型？Eureka、Zookeeper、Nacos怎么选

> 这是小卷对分布式系统架构学习的第9篇文章，第8篇时只回答了注册中心的工作原理的内容，面试官的第二个问题还没回答，今天再来讲讲各个注册中心的原理，以及区别，最后如何进行选型

上一篇文章：[如何设计一个注册中心？以Zookeeper为例](https://blog.csdn.net/qq_36624086/article/details/144975248)

还是先讲讲各个中间件的区别，zookeeper已经讲过了，这里开始讲其他中间件的工作原理

## 1. Eureka工作原理

Eureka的官方文档：[Netflix Eureka](https://github.com/Netflix/eureka/wiki) 

不过只有对1.0版本的文档，2.0之后的没有了。

**官方对Eureka的解释**：一种基于 REST（表述性状态转移）的服务，主要用于 AWS 云中定位服务，以实现中间层服务器的负载均衡和故障转移。称为 Eureka 服务器。

**Eureka解决的需求**是：在AWS中，服务器经常上线/下线，因此AWS需要动态地注册/注销负载均衡器上的服务器，而Eureka就是这样作为中间层负载均衡器出现的。

### 1.1高可用架构

Eureka在多个机房部署的架构图如下，这也是它高可用的优势

![](D:\IdeaProjects\find-next-dragon\bagu\img\9_注册中心选型1.png)

解释说明：

* 每个区域都部署一个 Eureka 集群，且该集群仅知道其区域内的实例，每个区域内至少有一个 Eureka 服务器，以处理区域故障；
* 服务向 Eureka 注册，然后每 30 秒发送一次心跳，以续租；如果客户端没有续租，90s后就会从注册中心剔除；
* 注册信息和续租信息会复制到集群中的所有Eureka节点；
* 任意客户端可以每隔30s请求一次获取注册信息，用于定位服务提供者，并发起远程调用

### 1.2 客户端-服务端间的通信

**（1）注册Register**

Eureka 客户端将运行实例的信息注册到 Eureka 服务器，注册在第一次心跳时发生（30 秒后）

**（2）续约机制Renew**

客户端每隔30 秒发送一次心跳来续租，通知 Eureka 服务器实例，当前客户端仍然处于存活状态。如果服务器在 90 秒内没有收到续租，它将把实例移出注册表；

* 续租方式是更新服务对象的最近续约时间，即lastUpdateTimestamp;

**（3）获取注册表 Fetch Registry**

* 客户端从服务器获取注册表信息并将其缓存到本地，之后客户端使用该信息表查找其他服务；

* 此信息会定期（每 30 秒）更新，通过获取上一个提取周期和当前周期之间的增量更新；
* 增量更新时，如果客户端通过比较注册表信息不匹配，则会请求整个注册表信息全量更新

**（4）下线Cancel**

Eureka Client 在程序关闭时向 Eureka Server 发送取消请求。 发送请求后，该客户端实例信息将从 Eureka Server 的实例注册表中删除。下线请求不会自动完成，需手动调用：

```java
DiscoveryManager.getInstance().shutdownComponent()
```

### 1.3自我保护机制

默认情况下，Eureka服务端在90s没有收到某个服务实例的心跳，就会注销该实例，将实例下线。如果出现大量实例心跳检测失败，Eureka就会认为是注册中心出现问题了，启动自我保护机制，**不再剔除这些失败实例**。触发条件阈值为：

* **注册表中超过15%的实例心跳检测失败**

### 1.4 小结

* Eureka属于AP模型，即牺牲一致性，来换取高可用。在部分阶段失效时，系统仍然能正常运作。但是服务节点间的数据可能不一致
* Eureka 客户端具备良好的弹性能力，即使与所有 Eureka 服务端的连接断开，它们依然能通过本地缓存机制正常工作
* 适合跨多机房，对注册中心可用性要求高的场景

## 2. Nacos工作原理





