# 分布式系统学习10：分布式事务

> 这是小卷对[分布式系统](https://so.csdn.net/so/search?q=分布式系统&spm=1001.2101.3001.7020)架构学习的第13篇文章，今天学习面试中高频问题：分布式事务，为什么要用分布式事务，分布式事务的实现方案有哪些，方案对比优缺点

## 1.知识体系

![](/Users/yuyunlong/IdeaProjects/find-next-dragon/bagu/img/分布式事务1.png)

## 1.为什么要用分布式事务

单体架构时，以本地事务为例，业务场景是下单场景，用户下单、创建订单、扣减库存这些操作都可以在一个数据库事务中完成。

![](/Users/yuyunlong/IdeaProjects/find-next-dragon/bagu/img/分布式事务2.png)

而随着业务的增长，系统转变为分布式系统，原有的单体架构也拆分为多个微服务。下单场景需要在多个服务间操作，需要保证所有操作都能成功，保证整个下单流程的数据一致性，就需要用到分布式事务了

![](/Users/yuyunlong/IdeaProjects/find-next-dragon/bagu/img/分布式事务3.png)

## 2.理论

- **分布式理论的CP** -> 刚性事务

遵循ACID，对数据要求强一致性

- **分布式理论的AP+BASE** -> 柔性事务

遵循BASE，允许一定时间内不同节点的数据不一致，但要求最终一致。

这里重新复习一遍BASE理论是什么：

* 基本可用 **Basically Available**
* 软状态 **Soft State**
* 最终一致性 **Eventually Consistent**

基本可用：是指系统出现未知故障时，还是能用的；

软状态：允许系统存在中间态，即所有副本数据允许存在延迟；

最终一致性：存在软状态，在一定时间后，所有副本数据保持一致，从而达到数据最终一致性；

## 3.刚性事务（CP模式）

刚性事务指的是强一致性，基础是XA协议，XA协议是一个基于**数据库**的分布式事务协议，其分为两部分：**事务管理器（Transaction Manager）\**和\**本地资源管理器（Resource Manager）**。事务管理器作为一个全局的调度者，负责对各个本地资源管理器统一号令提交或者回滚；

而2PC （两阶段提交）和3PC（三阶段提交）都是由XA协议衍生出来的

### 3.1两阶段提交（2PC）

> 引入一个作为协调者（coordinator）的组件来统一掌控所有参与者（participant）的操作结果，并最终指示这些节点是否要把操作结果进行真正的提交